<%= include_gon %>
<%= render "shared/header" %>

<div class="checkout-page">
  <div class="container">
    <div class="checkout-grid">
      <section class="order-summary-section">
        <h1 class="section-title">購入内容の確認</h1>

        <div class="product-summary">
          <div class="checkout-image">
             <%= image_tag @item.image.attached? ? @item.image : "item-sample.png", class: "summary-image" %>
          </div>
          <div class="product-details">
            <h2 class="product-name"><%= @item.name %></h2>
            <div class="price-info">
              <span class="price">¥<%= @item.price %></span>
            </div>
          </div>
        </div>

        <%# 利用可能クーポンを所持している場合のみ、プルダウン表示 %>
        <%# 選択されたクーポンのidをフォーム内の隠しフィールドで送信 %>
        <% if @available_coupons.any? %>
          <div class="coupon-selection-outside">
            <label for="coupon-select-outside">利用可能なクーポンを選択</label>
            <%= select_tag :coupon_id_outside,
                  options_for_select(
                    @available_coupons.map { |c|
                      ["#{c.name}（¥#{c.discount_amount} OFF）", c.id]
                    }
                  ),
                  include_blank: 'クーポンを使わない',
                  id: 'coupon-select-outside',
                  class: 'form-select' %>
            <%# クーポン関連のエラー表示用エリア %>
            <p id="coupon-error-outside" class="error-messages"></p>
          </div>
        <% end %>

        <div class="payment-summary">
          <div class="summary-row">
            <span>商品金額</span>
            <span>¥<%= @item.price %></span>
          </div>
          <div class="summary-row total">
            <span>お支払い金額</span>
            <span>¥<%= @item.price %></span>
          </div>
        </div>
      </section>
      <section class="payment-section">
        <%= form_with model: @order,url: order_item_path, id: 'charge-form', class: 'checkout-form',
                                                local: true do |f| %>

          <%= render 'shared/error_messages', model: @order %>

          <%# ★ Payjp Elementsのエラー表示用エリア %>
          <div id="card-error-messages" class="error-messages"></div>


          <%# カード情報の入力 %>
          <div class="form-section">
            <h2 class="form-section-title">クレジットカード情報</h2>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>カード番号</label>
                <span class="required-badge">必須</span>
              </div>
              <div id="number-form" class="card-input"></div>
              <div class="card-brands">
                <%= image_tag 'card-visa.gif', alt: 'Visa' %>
                <%= image_tag 'card-mastercard.gif', alt: 'Mastercard' %>
                <%= image_tag 'card-jcb.gif', alt: 'JCB' %>
                <%= image_tag 'card-amex.gif', alt: 'American Express' %>
              </div>
            </div>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>有効期限</label>
                <span class="required-badge">必須</span>
              </div>
              <div class='input-expiration-date-wrap'>
                <div id="expiry-form" class="card-input"></div>
              </div>
            </div>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>セキュリティコード</label>
                <span class="required-badge">必須</span>
              </div>
              <div id="cvc-form" class="card-input"></div>
            </div>
          </div>

          <div class="form-section">
            <h2 class="form-section-title">配送先情報</h2>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>郵便番号</label>
                <span class="required-badge">必須</span>
              </div>
              <%= f.text_field :postal_code, class: "form-input", placeholder: "例）123-4567", maxlength: "8", model: "@ship" %>
            </div>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>都道府県</label>
                <span class="required-badge">必須</span>
              </div>
              <%= f.collection_select :prefecture_id, Prefecture.all, :id, :name,
                  {}, { class: "form-select" } %>
            </div>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>市区町村</label>
                <span class="required-badge">必須</span>
              </div>
              <%= f.text_field :city, class: "form-input", placeholder: "例）横浜市緑区", model: "@ship" %>
            </div>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>番地</label>
                <span class="required-badge">必須</span>
              </div>
              <%= f.text_field :street_address, class: "form-input", placeholder: "例）青山1-1-1", model: "@ship" %>
            </div>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>建物名</label>
                <span class="optional-badge">任意</span>
              </div>
              <%= f.text_field :building_name, class: "form-input", placeholder: "例）柳ビル103", model: "@ship" %>
            </div>

            <div class="form-group">
              <div class="weight-bold-text">
                <label>電話番号</label>
                <span class="required-badge">必須</span>
              </div>
              <%= f.text_field :phone_number, class: "form-input", placeholder: "例）09012345678", maxlength: "11", model: "@ship" %>
            </div>
          </div>
          <%# /配送先の入力 %>

          <%# Payjpトークンを格納する隠しフィールド %>
          <%= f.hidden_field :token %>
          <%# coupon_idを送信する隠しフィールド。JSでnilになってるvalueを変更・・・？ %>
          <%= hidden_field_tag :coupon_id, nil, id: 'hidden-coupon-id'%>

          <div class="form-actions">
            <%= f.submit "購入を確定する", class: "submit-button", id: "button" %>
            <%= link_to "戻る", item_path(@item.id), class: "cancel-button" %>
          </div>
        <% end %>
      </section>
    </div>
  </div>
</div>

<%= render "shared/footer" %>